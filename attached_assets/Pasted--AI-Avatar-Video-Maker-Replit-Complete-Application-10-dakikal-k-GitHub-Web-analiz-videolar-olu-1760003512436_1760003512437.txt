"""
AI Avatar Video Maker - Replit Complete Application
10 dakikalÄ±k GitHub/Web analiz videolarÄ± oluÅŸturur
"""

from fastapi import FastAPI, HTTPException, BackgroundTasks
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import HTMLResponse
from pydantic import BaseModel, HttpUrl
from typing import Optional, Dict, List
import os
import uuid
import json
import asyncio
from datetime import datetime
import httpx

# ==================== CONFIGURATION ====================

app = FastAPI(title="AI Avatar Video Maker", version="1.0.0")

# CORS ayarlarÄ±
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# In-memory database (Replit DB ile deÄŸiÅŸtirilebilir)
videos_db = {}

# ==================== MODELS ====================

class VideoCreateRequest(BaseModel):
    url: HttpUrl
    avatar_type: str = "professional_female"
    voice_type: str = "tr_female_professional"
    video_style: str = "tutorial"

class VideoStatusResponse(BaseModel):
    video_id: str
    status: str
    progress: int
    current_stage: str
    video_url: Optional[str] = None
    youtube_url: Optional[str] = None
    created_at: Optional[str] = None
    completed_at: Optional[str] = None

# ==================== SERVICES ====================

class GitHubAnalyzer:
    """GitHub reposu analiz servisi"""
    
    @staticmethod
    async def analyze_repo(url: str) -> Dict:
        """GitHub repo bilgilerini Ã§eker"""
        try:
            # URL'den owner ve repo Ã§Ä±kar
            parts = url.replace("https://github.com/", "").replace("http://github.com/", "").split("/")
            if len(parts) < 2:
                raise ValueError("GeÃ§ersiz GitHub URL")
            
            owner, repo_name = parts[0], parts[1]
            
            # GitHub API (token gerektirmez - public)
            api_url = f"https://api.github.com/repos/{owner}/{repo_name}"
            
            async with httpx.AsyncClient() as client:
                response = await client.get(api_url)
                response.raise_for_status()
                repo_data = response.json()
                
                # README Ã§ek
                try:
                    readme_url = f"https://api.github.com/repos/{owner}/{repo_name}/readme"
                    readme_response = await client.get(readme_url)
                    readme_json = readme_response.json()
                    
                    # README content base64'ten decode et
                    import base64
                    readme_content = base64.b64decode(readme_json.get("content", "")).decode("utf-8")
                except:
                    readme_content = "README bulunamadÄ±"
                
                # Diller
                try:
                    lang_url = f"https://api.github.com/repos/{owner}/{repo_name}/languages"
                    lang_response = await client.get(lang_url)
                    languages = lang_response.json()
                except:
                    languages = {}
                
                return {
                    "name": repo_data.get("name"),
                    "full_name": repo_data.get("full_name"),
                    "description": repo_data.get("description", "AÃ§Ä±klama yok"),
                    "language": repo_data.get("language", "BelirtilmemiÅŸ"),
                    "stars": repo_data.get("stargazers_count", 0),
                    "forks": repo_data.get("forks_count", 0),
                    "watchers": repo_data.get("watchers_count", 0),
                    "open_issues": repo_data.get("open_issues_count", 0),
                    "topics": repo_data.get("topics", []),
                    "created_at": repo_data.get("created_at"),
                    "updated_at": repo_data.get("updated_at"),
                    "homepage": repo_data.get("homepage"),
                    "readme": readme_content[:3000],
                    "license": repo_data.get("license", {}).get("name", "BelirtilmemiÅŸ"),
                    "languages": languages,
                    "owner": owner,
                    "repo": repo_name
                }
        
        except Exception as e:
            raise Exception(f"GitHub analiz hatasÄ±: {str(e)}")

class ScriptGenerator:
    """AI ile script oluÅŸturma servisi"""
    
    @staticmethod
    async def generate_script(repo_data: Dict, style: str) -> Dict:
        """
        10 dakikalÄ±k TÃ¼rkÃ§e video scripti oluÅŸturur
        NOT: GerÃ§ek implementasyonda Claude/GPT API kullanÄ±lacak
        """
        
        # Demo script (production'da AI API kullanÄ±lacak)
        demo_script = f"""
[00:00-00:30] AÃ‡ILIÅ
Merhaba! BugÃ¼n {repo_data['name']} projesini inceleyeceÄŸiz. 
{repo_data['description']}

Bu videoda neler Ã¶ÄŸreneceksiniz?
âœ“ {repo_data['name']} nedir ve nasÄ±l Ã§alÄ±ÅŸÄ±r
âœ“ Ana Ã¶zellikleri nelerdir
âœ“ NasÄ±l kurulur ve kullanÄ±lÄ±r

Hadi baÅŸlayalÄ±m!

[00:30-02:00] PROJE TANITIMI
{repo_data['name']}, {repo_data['language']} programlama diliyle yazÄ±lmÄ±ÅŸ, 
GitHub'da {repo_data['stars']} yÄ±ldÄ±za sahip bir projedir.

Proje, {repo_data['description']} amacÄ±yla geliÅŸtirilmiÅŸtir.

Bu proje Ã¶zellikle ÅŸu durumlarda iÅŸinize yarayacak:
â€¢ {repo_data['topics'][:3] if repo_data['topics'] else ['Web geliÅŸtirme', 'API entegrasyonu', 'Otomasyon']}

[02:00-02:20] GEÃ‡Ä°Å 1
Åimdi ana Ã¶zelliklerine detaylÄ± bir ÅŸekilde bakalÄ±m...

[02:20-05:00] ANA Ã–ZELLÄ°KLER
Ã–zellik 1: HÄ±zlÄ± ve Kolay KullanÄ±m
{repo_data['name']} Ã§ok basit bir API'ye sahip...

Ã–zellik 2: GÃ¼Ã§lÃ¼ Performans
Proje, optimize edilmiÅŸ kod yapÄ±sÄ± sayesinde...

Ã–zellik 3: GeniÅŸ Topluluk DesteÄŸi
{repo_data['forks']} fork ve aktif bir geliÅŸtirici topluluÄŸu...

[05:00-05:20] GEÃ‡Ä°Å 2
Åimdi canlÄ± bir demo ile nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± gÃ¶relim...

[05:20-08:00] DEMO VE KULLANIM
GerÃ§ek bir kullanÄ±m senaryosu Ã¼zerinden...

[08:00-08:20] GEÃ‡Ä°Å 3
Kuruluma geÃ§elim...

[08:20-09:30] KURULUM
Ã–ncelikle gereksinimleri kontrol edin:
â€¢ {repo_data['language']} kurulu olmalÄ±
â€¢ Git kurulu olmalÄ±

Kurulum adÄ±mlarÄ±:
1. Repository'yi klonlayÄ±n
2. BaÄŸÄ±mlÄ±lÄ±klarÄ± yÃ¼kleyin
3. YapÄ±landÄ±rma dosyasÄ±nÄ± dÃ¼zenleyin

[09:30-10:00] KAPANIÅ
Ã–zetlersek, {repo_data['name']} projesi:
âœ“ Kolay kullanÄ±m
âœ“ GÃ¼Ã§lÃ¼ Ã¶zellikler
âœ“ Aktif topluluk desteÄŸi

Video iÅŸinize yaradÄ±ysa beÄŸenmeyi unutmayÄ±n!
Sonraki videoda gÃ¶rÃ¼ÅŸmek Ã¼zere! ğŸ‘‹
"""
        
        # Script'i bÃ¶lÃ¼mlere ayÄ±r
        sections = []
        current_section = None
        
        for line in demo_script.strip().split('\n'):
            if line.startswith('['):
                if current_section:
                    sections.append(current_section)
                
                # Timestamp ve baÅŸlÄ±k Ã§Ä±kar
                timestamp = line.split(']')[0].replace('[', '')
                title = line.split(']')[1].strip() if ']' in line else ""
                
                # Avatar mÄ± yoksa ekran kaydÄ± mÄ±?
                section_type = "avatar" if any(x in title.upper() for x in ["AÃ‡ILIÅ", "GEÃ‡Ä°Å", "KAPANIÅ"]) else "screen"
                
                current_section = {
                    "timestamp": timestamp,
                    "title": title,
                    "type": section_type,
                    "text": ""
                }
            elif current_section and line.strip():
                current_section["text"] += line + "\n"
        
        if current_section:
            sections.append(current_section)
        
        return {
            "full_text": demo_script,
            "sections": sections,
            "metadata": {
                "word_count": len(demo_script.split()),
                "estimated_duration": "10:00",
                "language": "tr"
            }
        }

class TTSService:
    """Text-to-Speech servisi"""
    
    @staticmethod
    async def generate_audio(script: Dict, voice_type: str) -> str:
        """
        Script'ten ses dosyasÄ± oluÅŸturur
        NOT: GerÃ§ek implementasyonda ElevenLabs/Azure TTS kullanÄ±lacak
        """
        await asyncio.sleep(2)  # SimÃ¼le edilmiÅŸ iÅŸlem
        return f"audio_{uuid.uuid4()}.mp3"

class AvatarService:
    """Avatar video render servisi"""
    
    @staticmethod
    async def render_avatar_segments(script: Dict, avatar_type: str) -> List[str]:
        """
        Avatar segmentlerini render eder (sadece geÃ§iÅŸ ve aÃ§Ä±lÄ±ÅŸ/kapanÄ±ÅŸ iÃ§in)
        NOT: GerÃ§ek implementasyonda D-ID API kullanÄ±lacak
        """
        avatar_segments = []
        
        for section in script["sections"]:
            if section["type"] == "avatar":
                await asyncio.sleep(1)  # SimÃ¼le edilmiÅŸ render
                avatar_segments.append(f"avatar_{section['timestamp']}.mp4")
        
        return avatar_segments

class ScreenRecorder:
    """Ekran kaydÄ± servisi"""
    
    @staticmethod
    async def create_screen_recordings(repo_data: Dict) -> List[str]:
        """
        Kod gÃ¶sterimleri ve demo ekran kayÄ±tlarÄ± oluÅŸturur
        NOT: GerÃ§ek implementasyonda Puppeteer kullanÄ±lacak
        """
        recordings = []
        
        # FarklÄ± ekran kayÄ±tlarÄ± oluÅŸtur
        screens = ["code_view", "demo", "terminal", "documentation"]
        
        for screen in screens:
            await asyncio.sleep(2)  # SimÃ¼le edilmiÅŸ kayÄ±t
            recordings.append(f"screen_{screen}.mp4")
        
        return recordings

class VideoComposer:
    """Video kompozisyon servisi"""
    
    @staticmethod
    async def compose_video(
        avatar_clips: List[str],
        screen_recordings: List[str],
        audio_file: str,
        script: Dict
    ) -> str:
        """
        TÃ¼m parÃ§alarÄ± birleÅŸtirip final videoyu oluÅŸturur
        NOT: GerÃ§ek implementasyonda FFmpeg kullanÄ±lacak
        """
        await asyncio.sleep(5)  # SimÃ¼le edilmiÅŸ kompozisyon
        return f"final_video_{uuid.uuid4()}.mp4"
    
    @staticmethod
    async def add_subtitles(video_path: str, script: Dict) -> str:
        """Alt yazÄ± ekler"""
        await asyncio.sleep(2)  # SimÃ¼le edilmiÅŸ iÅŸlem
        return f"video_with_subs_{uuid.uuid4()}.mp4"

class YouTubeUploader:
    """YouTube yÃ¼kleme servisi"""
    
    @staticmethod
    async def upload_video(video_path: str, repo_data: Dict, script: Dict) -> str:
        """
        YouTube'a video yÃ¼kler
        NOT: GerÃ§ek implementasyonda YouTube API kullanÄ±lacak
        """
        
        # SEO optimized baÅŸlÄ±k oluÅŸtur
        title = f"{repo_data['name']} Nedir? | DetaylÄ± Ä°nceleme ve KullanÄ±m Rehberi | 2025"
        
        # AÃ§Ä±klama oluÅŸtur
        description = f"""
ğŸ¯ {repo_data['name']} hakkÄ±nda bilmeniz gereken her ÅŸey!

Bu videoda {repo_data['name']}'Ä±n:
âœ… Ne olduÄŸunu
âœ… NasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ±
âœ… Ana Ã¶zelliklerini
âœ… Kurulum ve kullanÄ±mÄ±nÄ±

detaylÄ±ca anlatÄ±yorum.

â±ï¸ Zaman DamgalarÄ±:
00:00 - GiriÅŸ
00:30 - Proje TanÄ±tÄ±mÄ±
02:20 - Ana Ã–zellikler
05:20 - CanlÄ± Demo
08:20 - Kurulum Rehberi
09:30 - SonuÃ§

ğŸ”— FaydalÄ± Linkler:
ğŸ“¦ GitHub: https://github.com/{repo_data['owner']}/{repo_data['repo']}
â­ YÄ±ldÄ±z: {repo_data['stars']}
ğŸ´ Fork: {repo_data['forks']}

#{ repo_data['name']} #{repo_data['language']} #programlama #tÃ¼rkÃ§e #tutorial
"""
        
        await asyncio.sleep(3)  # SimÃ¼le edilmiÅŸ yÃ¼kleme
        
        # Demo YouTube URL
        video_id = f"demo_{uuid.uuid4().hex[:11]}"
        return f"https://youtube.com/watch?v={video_id}"

# ==================== PIPELINE ====================

async def process_video_pipeline(video_id: str, request: VideoCreateRequest):
    """
    Ana video Ã¼retim pipeline'Ä±
    """
    try:
        # Video kaydÄ±nÄ± baÅŸlat
        videos_db[video_id]["created_at"] = datetime.now().isoformat()
        
        # STAGE 1: URL Analizi (10%)
        update_progress(video_id, 10, "ğŸ“Š GitHub reposu analiz ediliyor...")
        await asyncio.sleep(2)
        repo_data = await GitHubAnalyzer.analyze_repo(str(request.url))
        
        # STAGE 2: Script OluÅŸturma (20%)
        update_progress(video_id, 20, "âœï¸ AI ile 10 dakikalÄ±k script oluÅŸturuluyor...")
        await asyncio.sleep(3)
        script = await ScriptGenerator.generate_script(repo_data, request.video_style)
        
        # STAGE 3: Ses OluÅŸturma (35%)
        update_progress(video_id, 35, "ğŸ¤ TÃ¼rkÃ§e profesyonel ses oluÅŸturuluyor...")
        await asyncio.sleep(4)
        audio_file = await TTSService.generate_audio(script, request.voice_type)
        
        # STAGE 4: Avatar Render (50%)
        update_progress(video_id, 50, "ğŸ­ Avatar videolarÄ± render ediliyor (2 dakika)...")
        await asyncio.sleep(5)
        avatar_clips = await AvatarService.render_avatar_segments(script, request.avatar_type)
        
        # STAGE 5: Ekran KayÄ±tlarÄ± (65%)
        update_progress(video_id, 65, "ğŸ’» Kod gÃ¶sterimleri ve demo oluÅŸturuluyor...")
        await asyncio.sleep(6)
        screen_recordings = await ScreenRecorder.create_screen_recordings(repo_data)
        
        # STAGE 6: Video Kompozisyonu (80%)
        update_progress(video_id, 80, "ğŸ¬ 10 dakikalÄ±k video birleÅŸtiriliyor...")
        await asyncio.sleep(8)
        final_video = await VideoComposer.compose_video(
            avatar_clips,
            screen_recordings,
            audio_file,
            script
        )
        
        # STAGE 7: Alt YazÄ± Ekleme (90%)
        update_progress(video_id, 90, "ğŸ“ TÃ¼rkÃ§e ve Ä°ngilizce alt yazÄ±lar ekleniyor...")
        await asyncio.sleep(3)
        video_with_subs = await VideoComposer.add_subtitles(final_video, script)
        
        # STAGE 8: YouTube YÃ¼kleme (95%)
        update_progress(video_id, 95, "ğŸ“º YouTube'a yÃ¼kleniyor...")
        await asyncio.sleep(4)
        youtube_url = await YouTubeUploader.upload_video(
            video_with_subs,
            repo_data,
            script
        )
        
        # TAMAMLANDI (100%)
        videos_db[video_id].update({
            "status": "completed",
            "progress": 100,
            "current_stage": "âœ… Video baÅŸarÄ±yla oluÅŸturuldu!",
            "video_url": video_with_subs,
            "youtube_url": youtube_url,
            "completed_at": datetime.now().isoformat(),
            "repo_data": repo_data
        })
        
    except Exception as e:
        videos_db[video_id].update({
            "status": "failed",
            "current_stage": f"âŒ Hata: {str(e)}",
            "progress": 0
        })

def update_progress(video_id: str, progress: int, stage: str):
    """Ä°lerleme durumunu gÃ¼nceller"""
    if video_id in videos_db:
        videos_db[video_id]["progress"] = progress
        videos_db[video_id]["current_stage"] = stage
        videos_db[video_id]["status"] = "processing"

# ==================== API ENDPOINTS ====================

@app.get("/", response_class=HTMLResponse)
async def root():
    """Ana sayfa - Web UI"""
    html_content = """
    <!DOCTYPE html>
    <html lang="tr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ğŸ¬ AI Avatar Video Maker</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: .5; }
            }
            .animate-pulse {
                animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }
        </style>
    </head>
    <body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
        <div class="container mx-auto px-4 py-12 max-w-4xl">
            <!-- Header -->
            <div class="text-center mb-12">
                <h1 class="text-6xl font-bold mb-4 text-indigo-900">
                    ğŸ¬ AI Avatar Video Maker
                </h1>
                <p class="text-xl text-gray-700">
                    GitHub reposu veya web sitesi girin, 10 dakikalÄ±k profesyonel video oluÅŸturalÄ±m!
                </p>
                <p class="text-sm text-gray-500 mt-2">
                    âš¡ Otomatik analiz â€¢ ğŸ­ AI Avatar â€¢ ğŸ¤ TÃ¼rkÃ§e ses â€¢ ğŸ“º YouTube yÃ¼kleme
                </p>
            </div>

            <!-- Main Card -->
            <div class="bg-white rounded-3xl shadow-2xl p-8 mb-8">
                <!-- URL Input -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        ğŸ”— GitHub Repository URL veya Web Sitesi
                    </label>
                    <input
                        type="url"
                        id="urlInput"
                        placeholder="https://github.com/kullanici/proje"
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-indigo-500 focus:border-indigo-500 transition"
                    />
                </div>

                <!-- Avatar Selection -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-3">
                        ğŸ­ Avatar Tipi
                    </label>
                    <div class="grid grid-cols-2 gap-4">
                        <button class="avatar-btn border-2 border-indigo-500 bg-indigo-50 rounded-xl p-4 hover:bg-indigo-100 transition" data-value="professional_female">
                            <div class="text-4xl mb-2">ğŸ‘©â€ğŸ’¼</div>
                            <div class="font-semibold">Profesyonel KadÄ±n</div>
                        </button>
                        <button class="avatar-btn border-2 border-gray-300 rounded-xl p-4 hover:bg-gray-50 transition" data-value="professional_male">
                            <div class="text-4xl mb-2">ğŸ‘¨â€ğŸ’¼</div>
                            <div class="font-semibold">Profesyonel Erkek</div>
                        </button>
                    </div>
                </div>

                <!-- Voice Selection -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-3">
                        ğŸ¤ Ses Tipi
                    </label>
                    <select id="voiceSelect" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-indigo-500">
                        <option value="tr_female_professional">KadÄ±n - Profesyonel</option>
                        <option value="tr_male_professional">Erkek - Profesyonel</option>
                        <option value="tr_female_young">KadÄ±n - GenÃ§ & Enerjik</option>
                        <option value="tr_male_deep">Erkek - Derin & Otoriter</option>
                    </select>
                </div>

                <!-- Video Style -->
                <div class="mb-8">
                    <label class="block text-sm font-semibold text-gray-700 mb-3">
                        ğŸ¬ Video Stili
                    </label>
                    <div class="grid grid-cols-3 gap-3">
                        <button class="style-btn border-2 border-indigo-500 bg-indigo-50 rounded-xl p-3 hover:bg-indigo-100 transition text-sm font-semibold" data-value="tutorial">
                            ğŸ“š Tutorial
                        </button>
                        <button class="style-btn border-2 border-gray-300 rounded-xl p-3 hover:bg-gray-50 transition text-sm font-semibold" data-value="review">
                            â­ Review
                        </button>
                        <button class="style-btn border-2 border-gray-300 rounded-xl p-3 hover:bg-gray-50 transition text-sm font-semibold" data-value="demo">
                            ğŸ’» Demo
                        </button>
                    </div>
                </div>

                <!-- Create Button -->
                <button
                    id="createBtn"
                    class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-xl font-bold text-lg hover:from-indigo-700 hover:to-purple-700 transition shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    ğŸ¬ Video OluÅŸtur (10 Dakika)
                </button>
            </div>

            <!-- Progress Card (Hidden by default) -->
            <div id="progressCard" class="bg-white rounded-3xl shadow-2xl p-8 hidden">
                <h3 class="text-2xl font-bold mb-6 text-center text-indigo-900">
                    ğŸ“Š Video OluÅŸturuluyor...
                </h3>

                <!-- Progress Bar -->
                <div class="mb-6">
                    <div class="flex justify-between mb-2">
                        <span class="text-sm font-semibold text-gray-700">Ä°lerleme</span>
                        <span id="progressPercent" class="text-sm font-bold text-indigo-600">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                        <div id="progressBar" class="bg-gradient-to-r from-indigo-500 to-purple-500 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Current Stage -->
                <div class="bg-indigo-50 rounded-xl p-4 mb-6">
                    <div class="flex items-center">
                        <div class="animate-pulse mr-3 text-2xl">â³</div>
                        <div>
                            <div class="text-xs text-gray-500 mb-1">Åu an:</div>
                            <div id="currentStage" class="font-semibold text-gray-800">
                                Ä°ÅŸlem baÅŸlatÄ±lÄ±yor...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Estimated Time -->
                <div class="text-center text-sm text-gray-600 mb-4">
                    â±ï¸ Tahmini SÃ¼re: <span class="font-semibold">45-60 dakika</span>
                </div>

                <!-- Result (Hidden by default) -->
                <div id="resultSection" class="hidden space-y-3">
                    <div class="bg-green-50 border-2 border-green-500 rounded-xl p-4 text-center">
                        <div class="text-4xl mb-2">âœ…</div>
                        <div class="font-bold text-green-900 mb-2">Video BaÅŸarÄ±yla OluÅŸturuldu!</div>
                    </div>
                    
                    <a id="youtubeLink" href="#" target="_blank" class="block w-full bg-red-600 text-white text-center py-4 rounded-xl font-bold text-lg hover:bg-red-700 transition shadow-lg">
                        ğŸ“º YouTube'da Ä°zle
                    </a>
                    
                    <button onclick="location.reload()" class="w-full bg-gray-600 text-white py-3 rounded-xl font-semibold hover:bg-gray-700 transition">
                        ğŸ”„ Yeni Video OluÅŸtur
                    </button>
                </div>
            </div>

            <!-- Info Section -->
            <div class="mt-12 grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white rounded-xl p-6 shadow-lg text-center">
                    <div class="text-4xl mb-3">âš¡</div>
                    <h3 class="font-bold text-lg mb-2">Otomatik Analiz</h3>
                    <p class="text-sm text-gray-600">GitHub repo veya web sitesini AI ile analiz eder</p>
                </div>
                <div class="bg-white rounded-xl p-6 shadow-lg text-center">
                    <div class="text-4xl mb-3">ğŸ­</div>
                    <h3 class="font-bold text-lg mb-2">AI Avatar</h3>
                    <p class="text-sm text-gray-600">Profesyonel avatar ile gÃ¶rsel zenginlik</p>
                </div>
                <div class="bg-white rounded-xl p-6 shadow-lg text-center">
                    <div class="text-4xl mb-3">ğŸ“º</div>
                    <h3 class="font-bold text-lg mb-2">YouTube Ready</h3>
                    <p class="text-sm text-gray-600">SEO optimized, otomatik yÃ¼kleme</p>
                </div>
            </div>
        </div>

        <script>
            let selectedAvatar = 'professional_female';
            let selectedStyle = 'tutorial';
            let pollingInterval = null;

            // Avatar selection
            document.querySelectorAll('.avatar-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.avatar-btn').forEach(b => {
                        b.classList.remove('border-indigo-500', 'bg-indigo-50');
                        b.classList.add('border-gray-300');
                    });
                    btn.classList.add('border-indigo-500', 'bg-indigo-50');
                    btn.classList.remove('border-gray-300');
                    selectedAvatar = btn.dataset.value;
                });
            });

            // Style selection
            document.querySelectorAll('.style-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.style-btn').forEach(b => {
                        b.classList.remove('border-indigo-500', 'bg-indigo-50');
                        b.classList.add('border-gray-300');
                    });
                    btn.classList.add('border-indigo-500', 'bg-indigo-50');
                    btn.classList.remove('border-gray-300');
                    selectedStyle = btn.dataset.value;
                });
            });

            // Create video
            document.getElementById('createBtn').addEventListener('click', async () => {
                const url = document.getElementById('urlInput').value;
                const voice = document.getElementById('voiceSelect').value;
                
                if (!url) {
                    alert('LÃ¼tfen bir URL girin!');
                    return;
                }

                try {
                    document.getElementById('createBtn').disabled = true;
                    document.getElementById('createBtn').textContent = 'â³ Ä°ÅŸlem BaÅŸlatÄ±lÄ±yor...';

                    const response = await fetch('/api/videos/create', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            url: url,
                            avatar_type: selectedAvatar,
                            voice_type: voice,
                            video_style: selectedStyle
                        })
                    });

                    const data = await response.json();
                    
                    if (response.ok) {
                        document.getElementById('progressCard').classList.remove('hidden');
                        startPolling(data.video_id);
                    } else {
                        alert('Hata: ' + (data.detail || 'Bilinmeyen hata'));
                        document.getElementById('createBtn').disabled = false;
                        document.getElementById('createBtn').textContent = 'ğŸ¬ Video OluÅŸtur (10 Dakika)';
                    }
                } catch (error) {
                    alert('BaÄŸlantÄ± hatasÄ±: ' + error.message);
                    document.getElementById('createBtn').disabled = false;
                    document.getElementById('createBtn').textContent = 'ğŸ¬ Video OluÅŸtur (10 Dakika)';
                }
            });

            function startPolling(videoId) {
                pollingInterval = setInterval(async () => {
                    try {
                        const response = await fetch(`/api/videos/${videoId}`);
                        const data = await response.json();

                        document.getElementById('progressBar').style.width = data.progress + '%';
                        document.getElementById('progressPercent').textContent = data.progress + '%';
                        document.getElementById('currentStage').textContent = data.current_stage;

                        if (data.status === 'completed') {
                            clearInterval(pollingInterval);
                            document.getElementById('youtubeLink').href = data.youtube_url;
                            document.getElementById('resultSection').classList.remove('hidden');
                        } else if (data.status === 'failed') {
                            clearInterval(pollingInterval);
                            alert('Video oluÅŸturma baÅŸarÄ±sÄ±z: ' + data.current_stage);
                        }
                    } catch (error) {
                        console.error('Polling error:', error);
                    }
                }, 3000);
            }
        </script>
    </body>
    </html>
    """
    return HTMLResponse(content=html_content)

@app.get("/health")
async def health_check():
    """SaÄŸlÄ±k kontrolÃ¼"""
    return {
        "status": "healthy",
        "version": "1.0.0",
        "videos_in_queue": len([v for v in videos_db.values() if v["status"] == "processing"]),
        "total_videos": len(videos_db)
    }

@app.post("/api/videos/create", response_model=VideoStatusResponse)
async def create_video(request: VideoCreateRequest, background_tasks: BackgroundTasks):
    """Yeni video oluÅŸturma"""
    try:
        video_id = str(uuid.uuid4())
        
        videos_db[video_id] = {
            "video_id": video_id,
            "url": str(request.url),
            "avatar_type": request.avatar_type,
            "voice_type": request.voice_type,
            "video_style": request.video_style,
            "status": "pending",
            "progress": 0,
            "current_stage": "â³ Ä°ÅŸlem sÄ±raya alÄ±ndÄ±",
            "video_url": None,
            "youtube_url": None,
            "created_at": None,
            "completed_at": None
        }
        
        background_tasks.add_task(process_video_pipeline, video_id, request)
        
        return VideoStatusResponse(**videos_db[video_id])
        
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@app.get("/api/videos/{video_id}", response_model=VideoStatusResponse)
async def get_video_status(video_id: str):
    """Video durumu sorgulama"""
    if video_id not in videos_db:
        raise HTTPException(status_code=404, detail="Video bulunamadÄ±")
    
    return VideoStatusResponse(**videos_db[video_id])

@app.get("/api/videos")
async def list_videos():
    """TÃ¼m videolarÄ± listele"""
    return {
        "total": len(videos_db),
        "videos": list(videos_db.values())
    }

# ==================== MAIN ====================

if __name__ == "__main__":
    import uvicorn
    port = int(os.getenv("PORT", 8000))
    print(f"""
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘                                                           â•‘
    â•‘        ğŸ¬ AI AVATAR VIDEO MAKER - REPLIT VERSION         â•‘
    â•‘                                                           â•‘
    â•‘  Server: http://0.0.0.0:{port}                              â•‘
    â•‘  Status: âœ… Running                                       â•‘
    â•‘                                                           â•‘
    â•‘  Endpoints:                                               â•‘
    â•‘  â€¢ GET  /           â†’ Web UI                             â•‘
    â•‘  â€¢ GET  /health     â†’ Health Check                       â•‘
    â•‘  â€¢ POST /api/videos/create â†’ Create Video                â•‘
    â•‘  â€¢ GET  /api/videos/:id â†’ Video Status                   â•‘
    â•‘                                                           â•‘
    â•‘  Demo Mode: TÃ¼m servisler simÃ¼le edilmiÅŸtir             â•‘
    â•‘  Production iÃ§in API key'leri ekleyin                    â•‘
    â•‘                                                           â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)
    uvicorn.run(app, host="0.0.0.0", port=port)